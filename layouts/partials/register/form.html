{{ $primaryColorScheme := .Site.Params.primaryColorScheme }}
<script src="https://www.google.com/recaptcha/enterprise.js?render={{ .Site.Params.recaptchaKey }}" async defer></script>
<div class="mt-4 sm:mx-auto sm:w-full sm:max-w-md px-6 lg:px-8">
  <form id="registration-form" class="space-y-6" action="#" method="POST">
    <div
      id="error-message"
      class="rounded-md bg-red-50 p-4"
      style="display: none;"
    >
      <div class="flex">
        <div class="flex-shrink-0">
          <svg
            class="h-5 w-5 text-red-400"
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
              clip-rule="evenodd"
            />
          </svg>
        </div>
        <div class="ml-3">
          <h3 id="error-text" class="text-sm font-medium text-red-800"></h3>
        </div>
      </div>
    </div>
    <div
      id="success-message"
      class="rounded-md bg-green-50 p-4"
      style="display: none;"
    >
      <div class="flex">
        <div class="flex-shrink-0">
          <svg
            class="h-5 w-5 text-green-400"
            viewBox="0 0 20 20"
            fill="currentColor"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z"
              clip-rule="evenodd"
            />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-green-800">
            {{ i18n "successMessage" . }}
          </p>
        </div>
      </div>
    </div>

    <div>
      <label
        for="name"
        class="block text-sm font-medium leading-6 text-gray-900"
      >
        {{ i18n "businessNameLabel" . }}
      </label>
      <div class="mt-2">
        <input
          id="name"
          name="name"
          type="text"
          autocomplete="off"
          required
          class="block w-full rounded-md border-0 px-3 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-{{ $primaryColorScheme }}-600 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div>
      <label
        for="country"
        class="block text-sm font-medium leading-6 text-gray-900"
      >
        {{ i18n "countryLabel" . }}
      </label>
      <div class="mt-2">
        <select
          id="country"
          name="country"
          autocomplete="country-name"
          class="h-10 block w-full rounded-md border-0 bg-white px-3 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-{{ $primaryColorScheme }}-600 sm:text-sm sm:leading-6"
        >
          <option value="AT">{{ i18n "austria" }}</option>
          <option value="BE">{{ i18n "belgium" }}</option>
          <option value="HR">{{ i18n "croatia" }}</option>
          <option value="CY">{{ i18n "cyprus" }}</option>
          <option value="EE">{{ i18n "estonia" }}</option>
          <option value="FI">{{ i18n "finland" }}</option>
          <option value="FR">{{ i18n "france" }}</option>
          <option value="DE" selected>{{ i18n "germany" }}</option>
          <option value="GR">{{ i18n "greece" }}</option>
          <option value="IE">{{ i18n "ireland" }}</option>
          <option value="IT">{{ i18n "italy" }}</option>
          <option value="LV">{{ i18n "latvia" }}</option>
          <option value="LT">{{ i18n "lithuania" }}</option>
          <option value="LU">{{ i18n "luxembourg" }}</option>
          <option value="MT">{{ i18n "malta" }}</option>
          <option value="NL">{{ i18n "netherlands" }}</option>
          <option value="PT">{{ i18n "portugal" }}</option>
          <option value="SK">{{ i18n "slovakia" }}</option>
          <option value="SI">{{ i18n "slovenia" }}</option>
          <option value="ES">{{ i18n "spain" }}</option>
        </select>
      </div>
    </div>

    <div class="flex gap-x-1 justify-between">
      <div>
        <label
          for="first-name"
          class="block text-sm font-medium leading-6 text-gray-900"
        >
          {{ i18n "firstNameLabel" . }}
        </label>
        <div class="mt-2">
          <input
            id="first-name"
            name="firstName"
            type="text"
            autocomplete="firstName"
            required
            class="block w-full rounded-md border-0 px-3 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-{{ $primaryColorScheme }}-600 sm:text-sm sm:leading-6"
          />
        </div>
      </div>
      <div>
        <label
          for="last-name"
          class="block text-sm font-medium leading-6 text-gray-900"
        >
          {{ i18n "lastNameLabel" . }}
        </label>
        <div class="mt-2">
          <input
            id="last-name"
            name="lastName"
            type="text"
            autocomplete="lastName"
            required
            class="block w-full rounded-md border-0 px-3 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-{{ $primaryColorScheme }}-600 sm:text-sm sm:leading-6"
          />
        </div>
      </div>
    </div>

    <div>
      <label
        for="email"
        class="block text-sm font-medium leading-6 text-gray-900"
      >
        {{ i18n "emailAddressLabel" . }}
      </label>
      <div class="mt-2">
        <input
          id="email"
          name="email"
          type="email"
          autocomplete="email"
          required
          class="block w-full rounded-md border-0 px-3 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-{{ $primaryColorScheme }}-600 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div>
      <label
        for="password"
        class="block text-sm font-medium leading-6 text-gray-900"
      >
        {{ i18n "passwordForVinrLabel" . }}
      </label>
      <div class="mt-2">
        <input
          id="password"
          name="password"
          type="password"
          autocomplete="current-password"
          required
          class="block w-full rounded-md border-0 px-3 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-{{ $primaryColorScheme }}-600 sm:text-sm sm:leading-6"
        />
      </div>
    </div>

    <div>
      <button
        id="submit-button"
        type="submit"
        class="flex w-full justify-center rounded-md bg-{{ $primaryColorScheme }}-600 px-3 py-1.5 text-sm font-semibold leading-6 text-white shadow-sm hover:bg-{{ $primaryColorScheme }}-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-{{ $primaryColorScheme }}-600"
      >
        {{ i18n "signUpButton" . }}
      </button>
    </div>
  </form>

  <p class="mt-10 text-center text-sm text-gray-500">
    {{ $baseURL := .Site.BaseURL }}
    {{ $currentLang := .Site.Language.Lang }}
    {{ $newBaseURL := strings.TrimRight "/" $baseURL }}
    {{ if ne $currentLang "en" }}
      {{ $newBaseURL = print $baseURL $currentLang }}
    {{ end }}
    {{ i18n "agreementText" . }}
    <a
      href="{{ $newBaseURL }}/terms"
      class="text-sm leading-6 text-gray-600 hover:text-gray-900"
    >
      {{ i18n "terms" . }}
    </a>
    &
    <a
      href="{{ $newBaseURL }}/privacy-policy"
      class="text-sm leading-6 text-gray-600 hover:text-gray-900"
    >
      {{ i18n "privacyPolicy" . }}
    </a>
  </p>
</div>
<script src="https://cdn.jsdelivr.net/npm/ulid@2.3.0/dist/index.umd.min.js"></script>
<script>
  document.getElementById('registration-form').addEventListener('submit', function (event) {
    event.preventDefault();
    document.getElementById('error-message').style.display = 'none';
    document.getElementById('submit-button').disabled = true;
    window.scrollTo({top: 0, left: 0, behavior: 'smooth'});
    const recaptchaKey = "{{ .Site.Params.recaptchaKey }}";
    const registerApiURL = "{{ .Site.Params.registerApiURL }}";
    const appURL = "{{ .Site.Params.appURL }}";

    grecaptcha.enterprise.ready(async () => {
      const token = await grecaptcha.enterprise.execute(recaptchaKey, {action: 'REGISTER'});
      const formData = {
        id: ULID.ulid(),
        name: document.getElementById('name').value,
        countryCode: document.getElementById('country').value,
        creator: {
          firstName: document.getElementById('first-name').value,
          lastName: document.getElementById('last-name').value,
          emailAddress: document.getElementById('email').value,
          password: document.getElementById('password').value
        },
        token: token
      };

      fetch(registerApiURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      })
        .then(response => {
          if (response.ok) {
            return response
          } else {
            throw response;
          }
        })
        .then(() => {
          document.getElementById('success-message').style.display = 'block';
          setTimeout(function () {
              window.location.href = appURL;
          }, 3000);
        })
        .catch((error) => {
          console.error(error)
          document.getElementById('submit-button').disabled = false;
          // Handle different response statuses
          if (error.status === 400) {
            document.getElementById('error-text').textContent = 'Invalid captcha. Please retry after refresh. If the issue persists, let us know.';
          } else if (error.status === 409) {
            document.getElementById('error-text').textContent = 'Looks like you are already registered. Please try to login.';
          } else {
            document.getElementById('error-text').textContent = 'Please retry. If the issue persists, let us know.';
          }
          document.getElementById('error-message').style.display = 'block';
        });
    });
  });
</script>
